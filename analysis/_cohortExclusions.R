library(dplyr) 
library(DatabaseConnector) 
library(SqlRender)
library(readr)
library(stringr)

# Cohort ID Setup ---------------------------------------------
#preparedCohortManifest <- prepManifestForCohortGenerator(getCohortManifest())

cohort_definition_id <- preparedCohortManifest %>%
  filter(cohortName == "Target_Cohort_0B") %>%
  pull(cohortId)

sql <- "
WITH CODESETS AS (
SELECT 10 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (443392)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (443392)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4112752,4111921,4334322,40493428,35610164,443399,443388,35610239,4311499,4151250,4157454,4300558,3187314,4298029,4191647,40484156,36716620,443392,40488448,604497,4301510,4300560,42513373,42514272,42513374,42513117,42514287,42513173,42513168,42514220,42514355,42514250,42513095,42513175,42513174,42514332,42513383,42513381,42513176,42514252,42513384,42513382,42513380,42513138,42514379,42511220,42513171,42513105,42513086,42514206,42513055,42514341,42514350,42513172,42513004,42511203,42513012,42513618,42514367,42513203,42514096,42514372,42513301,42513042,42513232,42513016,42514239,42513017,42514278,42514376,42513008,42513010,42513169,42513602,42514333,42513385,42513188,42513178,42513177,42513223,42514263,42514303,42513329,42514099,42513322,42513331,42514290,42513299,42514100,42513601,42514271,42511201,42513028,42514170,42514338,42513181,42514089,42513030,42514060,42513034,42513014,42514108,42514293,42513019,42514091,42513097,42514260,42513333,42514325,42513156,42514324,42513018,42511208,42514098,42513057,42513040,42513043,42514048,42513045,42513049,42513041,42513046,42514137,42513047,42514218,42514138,42513052,42513099,42514125,42514305,42511206,37166413,37166321,439392,4149322,37166411,37166415,36713996,4300559,4300118,4298030)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4112752,4111921,443399,443388)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C UNION ALL 
SELECT 11 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (21601387)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (21601387)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 12 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (602150,602163,602167,602169,602171,602682,602697,605445,605446,605447,605821,609075,609076,609077,609078,609079,609080,609081,3654297,3654301,3654352,4110589,4110590,4110705,4110706,4111805,4112738,4115276,4140471,4143825,4196724,4196725,4197581,4197582,4197583,37166577,37166601,37166604,37166605,37166607,37166608,37166615,37166624,37166642,37166666,37166667,37166668,37166728,37166735,37166745,37166759,37166760,37166762,37166768,37166771,37166773,37166774,37166775,37166780,37166789,37166794,37166795,37311684,42513174,42513175,42539251,44499007,44499010,44499488,44499513,44499688,44499726,44499741,44499794,44499863,44499882,44499889,44499900,44499915,44500048,44500072,44500114,44500183,44500190,44500303,44500348,44500356,44500359,44500414,44500415,44500448,44500577,44500790,44500841,44500984,44501059,44501061,44501086,44501124,44501191,44501310,44501388,44501404,44501411,44501438,44501516,44501613,44501707,44501709,44501794,44502109,44502176,44502238,44502329,44502334,44502341,44502456,44502457,44502466,44502543,44502623,44502703,44502711,44502764,44502784,44502876,44502885,44502921,44502943,44503004,44503018,44503034,44503093,44503098,44503136,44503138,44503152,44503538,45766129,45766131,45768879,45768880,45768881,45768884,45768885,45768886,45768916,45768917,45768918,45768919,45768920,45768921,45768922,45768923,45768928,45768930,45768931,45768932,45769034,45769035,45772933,45772938,46272955,4208307,4307118,4308479,4308784,4310448,4310703,4311452,4311997,4312274,4312768,4313200,4313751,4314040,4314156,4314172,4314832,4322387,36517902,36518654,36518742,36518808,36520748,36520827,36521546,36521617,36522300,36522427,36523265,36523365,36523702,36524730,36525052,36525571,36526019,36526433,36526753,36527609,36528862,36530069,36530344,36530431,36530839,36531136,36531433,36531819,36531901,36532026,36532437,36532844,36533348,36533515,36534932,36535081,36535086,36535558,36535903,36536513,36536832,36536903,36537250,36538056,36538464,36538582,36538987,36539497,36539786,36539915,36541038,36541640,36542106,36543615,36543960,36543984,36545785,36546130,36546410,36547828,36548193,36548201,36548626,36548970,36549159,36549175,36549769,36549979,36550126,36551240,36551342,36551818,36552086,36552385,36552939,36553787,36554642,36555703,36555776,36556450,36556614,36556919,36556975,36557751,36557771,36558543,36558787,36558877,36559186,36559892,36560118,36560716,36561274,36561693,36561870,36562727,36563600,36564925,36565647,36565803,36566204,36566369,36566849,36567491,36567502,36567522,36684857,36686537,36686538,36712707,36712708,36712709,36712815,36712816,36712981,36716426,36717017,37109576,37165673,37165675,37165750,37165756,37165759,37165766,37165772,37165786,37166234,37166235,37166236,37166238,37166276,37166277,37166278,37166279,37166280,37166328,37166330,37166520,37166536,44501357,36560845,44501585,36531338,44502549,36567582,36561283,36564508,36520679,36541364,44500290,36518010,44502769,36536437,44499686,36531120,36545242,44502961,36525316,36548902,36540691,36558592,36555136,36536720,36524040,44503010,44502436,44501567,36541713,44500287,36561810,44501740,36549254,36553640,36550205,44503111,44502949,44499508,42511851,36517234,36552199,36529740,36539842,36537196,36529691,44502320,44503539,36544137,36532996,44500573,44500918,44503537,36550921,36524261,36560935,36526440,44502426,44500480,36565633,42512265,42512505,42512456,42511962,42512801,42512752,42512246,42512620,42512222,42512380,42512616,42512867,42512859,42512336,42512569,42511979,42511673,42511853,36532293,36529938,36563834,36563105,36537460,36567546,44502952,36520186,44500201,44500302,44500188,44500713,44501471,36551824,44499422,44500730,44500343,44501394,44499866,44500843,44501558,36519829,44501926,44499947,44501560,44499623,36517425,44500710,44500458,44502390,36541699,36545286,36531543,44500061,44502856,44499621,36528414,36538391,44501559,36522039,44500239,36531347,36554751,36567060,44500855,44501188,44500433,36567972,44501335,36567150,36541027,36534747,36549522,45772939)

) I
) C UNION ALL 
SELECT 13 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (443392)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (443392)
  and c.invalid_reason is null

) I
LEFT JOIN
(
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (4111921,4112752)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (4111921,4112752)
  and c.invalid_reason is null

) E ON I.concept_id = E.concept_id
WHERE E.concept_id is null
) C
),
broad_primary AS (
  SELECT 
    'broad_primary' as condition_type, d.condition_concept_id, d.person_id, min(ABS(DATEDIFF(day, d.condition_start_date, c.cohort_start_date))) as days_to_event, c.cohort_definition_id
  FROM @cdm_database_schema.condition_occurrence d
  INNER JOIN @cohort_database_schema.@cohort_table c 
    ON d.person_id = c.subject_id
    AND c.cohort_definition_id = @cohort_definition_id
    AND d.condition_start_date <= DATEADD(day, -60, c.cohort_start_date)
  WHERE d.condition_concept_id IN (SELECT concept_id FROM CODESETS WHERE codeset_id = 13)
  GROUP BY d.person_id, d.condition_concept_id, c.cohort_definition_id
),
non_resp_primary AS (
  SELECT 'non_resp_primary' as condition_type, d.condition_concept_id, d.person_id, min(ABS(DATEDIFF(day, d.condition_start_date, c.cohort_start_date))) as days_to_event, c.cohort_definition_id
  FROM @cdm_database_schema.condition_occurrence d
  INNER JOIN @cohort_database_schema.@cohort_table c 
    ON d.person_id = c.subject_id
    AND c.cohort_definition_id = @cohort_definition_id
    AND d.condition_start_date >= DATEADD(day, -60, c.cohort_start_date)
    AND d.condition_start_date <= DATEADD(day, 30, c.cohort_start_date)
  WHERE d.condition_concept_id IN (SELECT concept_id FROM CODESETS WHERE codeset_id = 10)
  GROUP BY d.person_id, d.condition_concept_id, c.cohort_definition_id
),
union_table AS (
SELECT * FROM broad_primary
UNION
SELECT * FROM non_resp_primary
)
SELECT u.*, c.concept_name FROM union_table u
LEFT JOIN @vocabulary_database_schema.concept c ON u.condition_concept_id = c.concept_id

"
sql <- SqlRender::render(
  sql,
  vocabulary_database_schema = executionSettings$vocabDatabaseSchema,
  cdm_database_schema = executionSettings$cdmDatabaseSchema,
  cohort_database_schema = executionSettings$workDatabaseSchema,
  cohort_table = executionSettings$cohortTable,
  cohort_definition_id = cohort_definition_id
)

sql <- SqlRender::translate(sql, targetDialect = connectionDetails$dbms)

result <- dbGetQuery(con, sql) %>%
  summarise(
    count = n(),
    min = min(days_to_event),
    lq = quantile(days_to_event, 0.25),
    median = quantile(days_to_event, 0.5),
    uq = quantile(days_to_event, 0.75),
    max = max(days_to_event),
    .by = c(concept_name, condition_type, cohort_definition_id, condition_concept_id)
  ) %>%
  arrange(desc(count))

save_dir <- file.path(outputFolder, "study_results", "comorbidities")
  
dir.create(save_dir, showWarnings = FALSE, recursive = TRUE)

result %>%
  mutate(count = case_when(count > 0 & count < minCellCount ~ -minCellCount,
                           TRUE ~ count)) %>%  
 mutate(across(min:max, ~case_when(count < 0 ~ NA, TRUE ~ .x))) %>%
  write_csv(file.path(outputFolder, "study_results", "comorbidities", "excluded_concepts.csv"))


